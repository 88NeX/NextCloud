---
- name: Initialize swarm on first manager
  shell: |
    docker swarm init --advertise-addr {{ ansible_host }} || true
  register: swarm_init
  failed_when: false

- name: Get manager join token
  shell: docker swarm join-token manager -q
  register: manager_token
  changed_when: false

- name: Get worker join token
  shell: docker swarm join-token worker -q
  register: worker_token
  changed_when: false

- name: Set join tokens fact on control node
  set_fact:
    manager_join_token: "{{ manager_token.stdout }}"
    worker_join_token: "{{ worker_token.stdout }}"
  when: manager_token.stdout is defined
