user  nginx;
worker_processes  auto;
pid /run/nginx.pid;

events {
    worker_connections 10240;
}

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    client_max_body_size 0;

    gzip on;
    gzip_disable "msie6";

    upstream php-upstream {
        server nextcloud:9000;
    }

    server {
        listen 8080;
        server_name {{ domain_name }};

        root /var/www/html;

        location = /robots.txt { allow all; log_not_found off; access_log off; }
        location = /.well-known/carddav { return 301 $scheme://$host/remote.php/dav; }
        location = /.well-known/caldav  { return 301 $scheme://$host/remote.php/dav; }

        location / {
            rewrite ^ /index.php$request_uri;
        }

        location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ {
            deny all;
        }

        location ~ \.php(?:$|/) {
            fastcgi_split_path_info ^(.+\.php)(/.*)$;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_pass php-upstream;
            fastcgi_intercept_errors on;
        }

        location ~* \.(?:css|js|svg|gif|png|jpg|jpeg)$ {
            try_files $uri /index.php$request_uri;
            access_log off;
            expires 1M;
            add_header Cache-Control "public";
        }

        location ~* \.well-known/acme-challenge/ {
            root /var/www/letsencrypt;
            allow all;
        }
    }
}
